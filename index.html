<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SC Ice Storm News | DR 153-26</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.5;
        }
        .header {
            background: #d32f2f;
            color: white;
            padding: 20px 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .header h1 { font-size: 24px; margin-bottom: 4px; }
        .header .subtitle { font-size: 13px; opacity: 0.9; }
        .header .meta { font-size: 11px; margin-top: 8px; opacity: 0.8; }

        .controls {
            background: white;
            padding: 16px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
        }
        .controls label { font-size: 13px; display: flex; align-items: center; gap: 6px; cursor: pointer; }
        .controls input[type="checkbox"] { width: 16px; height: 16px; accent-color: #c62828; }
        .controls input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            width: 200px;
        }
        .controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .controls .filter-count {
            font-size: 12px;
            color: #666;
            margin-left: auto;
        }
        .btn {
            background: #c62828;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover { background: #b71c1c; }
        .btn:disabled { background: #999; cursor: not-allowed; }

        .container { max-width: 1000px; margin: 0 auto; padding: 24px; }

        .stats-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-card {
            background: white;
            border-radius: 6px;
            padding: 12px 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 120px;
        }
        .stat-card .number { font-size: 28px; font-weight: bold; color: #c62828; }
        .stat-card .label { font-size: 11px; color: #666; text-transform: uppercase; }

        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #c62828;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .article {
            background: white;
            border-radius: 6px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid transparent;
        }
        .article.red-cross {
            border-left-color: #c62828;
            background: #fff5f5;
        }
        .article .source {
            font-size: 11px;
            font-weight: 600;
            color: #c62828;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .article .rc-badge {
            background: #c62828;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }
        .article h3 {
            font-size: 15px;
            margin-bottom: 6px;
            line-height: 1.4;
        }
        .article h3 a { color: #333; text-decoration: none; }
        .article h3 a:hover { color: #c62828; }
        .article .summary {
            font-size: 13px;
            color: #666;
            margin-bottom: 6px;
        }
        .article .date {
            font-size: 11px;
            color: #999;
        }

        .section-header {
            background: #c62828;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-weight: 600;
            font-size: 14px;
        }

        .footer {
            text-align: center;
            padding: 20px;
            font-size: 11px;
            color: #999;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <h1>South Carolina Ice Storm</h1>
        <div class="subtitle">DR 153-26 | Disaster News Monitoring</div>
        <div class="meta">Prepared By: Gary Pelletier | <span id="currentDate"></span></div>
    </div>

    <div class="controls">
        <label>
            <input type="checkbox" id="rcOnly">
            Red Cross Only
        </label>
        <input type="text" id="searchInput" placeholder="Search articles...">
        <select id="sourceFilter">
            <option value="">All Sources</option>
        </select>
        <button class="btn" id="exportPdf">Export PDF</button>
        <button class="btn" id="refreshBtn">Refresh</button>
        <span class="filter-count" id="filterCount"></span>
    </div>

    <div class="container">
        <div class="stats-bar">
            <div class="stat-card">
                <div class="number" id="totalCount">-</div>
                <div class="label">Articles</div>
            </div>
            <div class="stat-card">
                <div class="number" id="sourceCount">-</div>
                <div class="label">Sources</div>
            </div>
            <div class="stat-card">
                <div class="number" id="rcCount">-</div>
                <div class="label">Red Cross</div>
            </div>
        </div>

        <div id="content">
            <div class="loading">Loading news articles</div>
        </div>
    </div>

    <div class="footer">
        American Red Cross | DR 153-26 | News updated every refresh
    </div>

    <script>
        let allArticles = [];

        // Set current date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });

        async function loadNews() {
            document.getElementById('content').innerHTML = '<div class="loading">Loading news articles</div>';

            try {
                const resp = await fetch('/api/crawl');
                const data = await resp.json();
                allArticles = data.articles || [];

                // Update stats
                document.getElementById('totalCount').textContent = allArticles.length;
                const sources = [...new Set(allArticles.map(a => a.source))];
                document.getElementById('sourceCount').textContent = sources.length;

                const rcArticles = allArticles.filter(a =>
                    (a.title + ' ' + a.summary).toLowerCase().includes('red cross')
                );
                document.getElementById('rcCount').textContent = rcArticles.length;

                // Populate source filter
                const sourceSelect = document.getElementById('sourceFilter');
                sourceSelect.innerHTML = '<option value="">All Sources</option>';
                sources.sort().forEach(src => {
                    sourceSelect.innerHTML += `<option value="${src}">${src}</option>`;
                });

                renderArticles();
            } catch (err) {
                document.getElementById('content').innerHTML =
                    '<div style="color:#c62828;padding:40px;text-align:center;">Error loading news. Please refresh.</div>';
            }
        }

        function isRedCross(article) {
            return (article.title + ' ' + (article.summary || '')).toLowerCase().includes('red cross');
        }

        function renderArticles() {
            const rcOnly = document.getElementById('rcOnly').checked;
            const search = document.getElementById('searchInput').value.toLowerCase();
            const sourceFilter = document.getElementById('sourceFilter').value;

            let filtered = allArticles.filter(a => {
                if (rcOnly && !isRedCross(a)) return false;
                if (sourceFilter && a.source !== sourceFilter) return false;
                if (search) {
                    const text = (a.title + ' ' + a.summary + ' ' + a.source).toLowerCase();
                    if (!text.includes(search)) return false;
                }
                return true;
            });

            // Update filter count
            document.getElementById('filterCount').textContent =
                `Showing ${filtered.length} of ${allArticles.length} articles`;

            // Separate Red Cross articles
            const rcArticles = filtered.filter(a => isRedCross(a));
            const otherArticles = filtered.filter(a => !isRedCross(a));

            let html = '';

            // Red Cross section first
            if (rcArticles.length > 0) {
                html += '<div class="section-header">RED CROSS MENTIONS</div>';
                rcArticles.forEach(a => {
                    html += renderArticle(a, true);
                });
            }

            // Other articles
            if (otherArticles.length > 0) {
                if (rcArticles.length > 0) {
                    html += '<div class="section-header" style="background:#666;margin-top:20px;">OTHER NEWS</div>';
                }
                otherArticles.forEach(a => {
                    html += renderArticle(a, false);
                });
            }

            if (filtered.length === 0) {
                html = '<div style="text-align:center;padding:40px;color:#666;">No articles match your filters.</div>';
            }

            document.getElementById('content').innerHTML = html;
        }

        function renderArticle(a, isRC) {
            const title = a.title || 'No title';
            const titleHighlighted = isRC ?
                title.replace(/red cross/gi, '<span style="color:#c62828;font-weight:bold;">Red Cross</span>') :
                title;

            let summary = a.summary || '';
            if (isRC && summary) {
                summary = summary.replace(/red cross/gi, '<span style="color:#c62828;font-weight:bold;">Red Cross</span>');
            }

            return `
                <div class="article ${isRC ? 'red-cross' : ''}">
                    <div class="source">
                        ${a.source}
                        ${isRC ? '<span class="rc-badge">RED CROSS</span>' : ''}
                    </div>
                    <h3><a href="${a.url}" target="_blank">${titleHighlighted}</a></h3>
                    ${summary ? `<div class="summary">${summary.substring(0, 200)}</div>` : ''}
                    <div class="date">${a.published || ''}</div>
                </div>
            `;
        }

        // Event listeners
        document.getElementById('rcOnly').addEventListener('change', renderArticles);
        document.getElementById('searchInput').addEventListener('input', renderArticles);
        document.getElementById('sourceFilter').addEventListener('change', renderArticles);
        document.getElementById('refreshBtn').addEventListener('click', loadNews);

        // PDF Export
        document.getElementById('exportPdf').addEventListener('click', async function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'Generating...';

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                let y = 15;

                // Header
                doc.setFillColor(211, 47, 47);
                doc.rect(0, 0, pageWidth, 35, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('South Carolina Ice Storm', 15, 15);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text('DR 153-26 | Disaster Operations Briefing', 15, 23);
                doc.text('Prepared By: Gary Pelletier | ' + new Date().toLocaleDateString(), 15, 30);

                y = 45;
                doc.setTextColor(0, 0, 0);

                // Stats
                doc.setFontSize(10);
                doc.setTextColor(198, 40, 40);
                const rcCount = allArticles.filter(a => isRedCross(a)).length;
                doc.text(`${allArticles.length} Articles | ${rcCount} Red Cross Mentions | Generated ${new Date().toLocaleTimeString()}`, pageWidth/2, y, {align: 'center'});
                y += 12;

                // Red Cross articles first
                const rcArticles = allArticles.filter(a => isRedCross(a));
                const otherArticles = allArticles.filter(a => !isRedCross(a));

                if (rcArticles.length > 0) {
                    doc.setFillColor(198, 40, 40);
                    doc.rect(15, y, pageWidth - 30, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text('RED CROSS MENTIONS', 20, y + 6);
                    y += 14;

                    doc.setTextColor(0, 0, 0);
                    rcArticles.slice(0, 10).forEach(a => {
                        if (y > 270) { doc.addPage(); y = 20; }
                        doc.setFontSize(8);
                        doc.setTextColor(198, 40, 40);
                        doc.setFont('helvetica', 'bold');
                        doc.text(a.source.toUpperCase(), 15, y);
                        y += 4;
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        const title = doc.splitTextToSize(a.title || '', pageWidth - 35);
                        doc.text(title, 15, y);
                        y += title.length * 4 + 2;
                        if (a.published) {
                            doc.setFontSize(7);
                            doc.setTextColor(150, 150, 150);
                            doc.text(a.published.substring(0, 25), 15, y);
                            y += 6;
                        }
                        y += 4;
                    });
                }

                // Other articles
                if (otherArticles.length > 0) {
                    y += 6;
                    doc.setFontSize(11);
                    doc.setTextColor(198, 40, 40);
                    doc.setFont('helvetica', 'bold');
                    doc.text('NEWS ARTICLE DETAILS', 15, y);
                    y += 8;

                    otherArticles.slice(0, 15).forEach(a => {
                        if (y > 270) { doc.addPage(); y = 20; }
                        doc.setFontSize(8);
                        doc.setTextColor(198, 40, 40);
                        doc.setFont('helvetica', 'bold');
                        doc.text(a.source.toUpperCase(), 15, y);
                        y += 4;
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        doc.setFont('helvetica', 'normal');
                        const title = doc.splitTextToSize(a.title || '', pageWidth - 35);
                        doc.text(title, 15, y);
                        y += title.length * 4 + 2;
                        if (a.published) {
                            doc.setFontSize(7);
                            doc.setTextColor(150, 150, 150);
                            doc.text(a.published.substring(0, 25), 15, y);
                            y += 6;
                        }
                        y += 4;
                    });
                }

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`American Red Cross | DR 153-26 | Generated ${new Date().toISOString().split('T')[0]}`, pageWidth/2, 285, {align: 'center'});

                doc.save('SC-DR153-26-News-Summary.pdf');
            } catch (err) {
                alert('PDF generation failed: ' + err.message);
            }

            btn.disabled = false;
            btn.textContent = 'Export PDF';
        });

        // Initial load
        loadNews();
    </script>
</body>
</html>
