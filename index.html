<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SC Ice Storm News | American Red Cross</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; line-height: 1.5; }
        .header { background: #d32f2f; color: white; padding: 10px 24px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .header-left h1 { font-size: 18px; margin-bottom: 2px; }
        .header-left .subtitle { font-size: 11px; opacity: 0.9; }
        .header-right { display: flex; gap: 8px; align-items: center; }
        .header-right .updated { font-size: 10px; opacity: 0.8; margin-right: 8px; }
        .btn { display: inline-flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.2); color: white; padding: 6px 12px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); font-size: 11px; cursor: pointer; transition: background 0.2s; }
        .btn:hover { background: rgba(255,255,255,0.3); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn.pdf-btn { background: rgba(0,0,0,0.2); }
        .btn .spinner { display: none; width: 12px; height: 12px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; }
        .btn.loading .spinner { display: block; }
        .btn.loading .icon { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .container { max-width: 1200px; margin: 0 auto; padding: 10px 16px; }
        .stats-bar { display: flex; gap: 8px; margin-bottom: 10px; }
        .stat-card { background: white; border-radius: 6px; padding: 8px 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex: 1; }
        .stat-card .number { font-size: 20px; font-weight: bold; color: #c62828; }
        .stat-card .label { font-size: 9px; color: #666; text-transform: uppercase; }
        .main-content { display: grid; grid-template-columns: 1fr 260px; gap: 16px; }
        @media (max-width: 900px) { .main-content { grid-template-columns: 1fr; } }
        .articles-section { background: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 16px; max-height: 70vh; overflow-y: auto; }
        .section-title { font-size: 14px; color: #c62828; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #ffcdd2; }
        .article-card { padding: 10px 0; border-bottom: 1px solid #e0e0e0; }
        .article-card:last-child { border-bottom: none; }
        .article-source { font-size: 9px; color: #c62828; text-transform: uppercase; font-weight: 600; margin-bottom: 2px; }
        .article-title { font-size: 13px; line-height: 1.3; margin-bottom: 4px; }
        .article-title a { color: #333; text-decoration: none; }
        .article-title a:hover { color: #c62828; text-decoration: underline; }
        .summary { font-size: 11px; color: #666; margin-bottom: 4px; }
        .article-meta { font-size: 10px; color: #999; }
        .sidebar { display: flex; flex-direction: column; gap: 12px; }
        .sidebar-card { background: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 12px; }
        .sidebar-card h3 { font-size: 11px; color: #c62828; text-transform: uppercase; margin-bottom: 10px; }
        .source-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #f0f0f0; font-size: 11px; }
        .source-item:last-child { border-bottom: none; }
        .source-count { font-weight: bold; color: #c62828; }
        .footer { text-align: center; padding: 12px; color: #999; font-size: 10px; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; }
        .loading-overlay.active { display: flex; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #ffcdd2; border-top-color: #c62828; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 12px; }
        .loading-text { color: #c62828; font-weight: 500; font-size: 14px; }
        .loading-sub { color: #666; font-size: 11px; margin-top: 4px; }
        .live-badge { display: inline-block; padding: 1px 6px; border-radius: 8px; font-size: 8px; margin-left: 6px; background: #e8f5e9; color: #2e7d32; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Crawling news sources...</div>
            <div class="loading-sub" id="loadingSub"></div>
        </div>
    </div>

    <div class="header">
        <div class="header-left">
            <h1>South Carolina Ice Storm</h1>
            <div class="subtitle">DR 153-26 | American Red Cross</div>
        </div>
        <div class="header-right">
            <span class="updated" id="lastUpdated">Loading...</span>
            <button class="btn" id="refreshBtn" onclick="refreshNews()">
                <span class="icon">&#x21bb;</span>
                <span class="spinner"></span>
                Refresh
            </button>
            <button class="btn pdf-btn" id="pdfBtn" onclick="exportPDF()">
                <span class="icon">&#x1F4C4;</span>
                Export PDF
            </button>
        </div>
    </div>

    <div class="container">
        <div class="stats-bar">
            <div class="stat-card">
                <div class="number" id="totalArticles">--</div>
                <div class="label">Articles</div>
            </div>
            <div class="stat-card">
                <div class="number" id="totalSources">--</div>
                <div class="label">Sources</div>
            </div>
            <div class="stat-card">
                <div class="number" id="redCrossMentions">--</div>
                <div class="label">Red Cross</div>
            </div>
        </div>

        <div class="main-content">
            <div class="articles-section">
                <h2 class="section-title">Latest Coverage <span class="live-badge">LIVE</span></h2>
                <div id="articlesContainer"><p style="color: #999; padding: 20px; text-align: center;">Loading articles...</p></div>
            </div>
            <div class="sidebar">
                <div class="sidebar-card">
                    <h3>Sources</h3>
                    <div id="sourcesContainer">Loading...</div>
                </div>
                <div class="sidebar-card">
                    <h3>Search Terms</h3>
                    <div style="display:flex;flex-wrap:wrap;gap:4px;">
                        <span style="background:#ffebee;color:#c62828;padding:2px 8px;border-radius:10px;font-size:9px;">SC ice storm</span>
                        <span style="background:#ffebee;color:#c62828;padding:2px 8px;border-radius:10px;font-size:9px;">SC winter storm</span>
                        <span style="background:#ffebee;color:#c62828;padding:2px 8px;border-radius:10px;font-size:9px;">SC power outage</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">American Red Cross | News Monitoring | <span id="footerTime"></span></div>

    <script>
        let isLoading = false;
        let currentArticles = [];

        async function refreshNews() {
            if (isLoading) return;
            isLoading = true;
            const btn = document.getElementById('refreshBtn');
            const overlay = document.getElementById('loadingOverlay');
            document.getElementById('loadingText').textContent = 'Crawling news sources...';
            document.getElementById('loadingSub').textContent = '';
            btn.classList.add('loading');
            btn.disabled = true;
            overlay.classList.add('active');

            try {
                const response = await fetch('/api/crawl');
                const data = await response.json();
                currentArticles = data.articles || [];
                renderNews(data);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('articlesContainer').innerHTML = '<p style="color: #c62828; padding: 20px; text-align: center;">Error loading news.</p>';
            } finally {
                isLoading = false;
                btn.classList.remove('loading');
                btn.disabled = false;
                overlay.classList.remove('active');
            }
        }

        function renderNews(data) {
            const articles = data.articles || [];
            document.getElementById('totalArticles').textContent = articles.length;
            const sources = {};
            let rcCount = 0;
            articles.forEach(a => {
                sources[a.source] = (sources[a.source] || 0) + 1;
                if ((a.title + ' ' + (a.summary || '')).toLowerCase().includes('red cross')) rcCount++;
            });
            document.getElementById('totalSources').textContent = Object.keys(sources).length;
            document.getElementById('redCrossMentions').textContent = rcCount;
            const now = new Date();
            document.getElementById('lastUpdated').textContent = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            document.getElementById('footerTime').textContent = now.toISOString().slice(0, 16).replace('T', ' ');

            let html = '';
            articles.forEach(a => {
                const summary = a.summary ? '<p class="summary">' + esc(a.summary.slice(0,120)) + '</p>' : '';
                html += '<div class="article-card"><div class="article-source">' + esc(a.source) + '</div><h3 class="article-title"><a href="' + esc(a.url) + '" target="_blank">' + esc(a.title) + '</a></h3>' + summary + '<div class="article-meta">' + esc((a.published || '').slice(0, 25)) + '</div></div>';
            });
            document.getElementById('articlesContainer').innerHTML = html || '<p style="color:#999;padding:20px;text-align:center;">No articles found.</p>';

            let srcHtml = '';
            Object.entries(sources).sort((a,b) => b[1] - a[1]).forEach(([name, count]) => {
                srcHtml += '<div class="source-item"><span>' + esc(name) + '</span><span class="source-count">' + count + '</span></div>';
            });
            document.getElementById('sourcesContainer').innerHTML = srcHtml || 'No sources';
        }

        function esc(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

        async function exportPDF() {
            const overlay = document.getElementById('loadingOverlay');
            document.getElementById('loadingText').textContent = 'Generating AI Summary...';
            document.getElementById('loadingSub').textContent = 'Analyzing articles with Claude AI';
            overlay.classList.add('active');

            let aiSummary = null;
            try {
                const resp = await fetch('/api/summary', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({articles: currentArticles})
                });
                aiSummary = await resp.json();
            } catch (e) {
                console.log('AI summary failed, using fallback');
            }

            document.getElementById('loadingText').textContent = 'Building PDF...';
            document.getElementById('loadingSub').textContent = '';

            setTimeout(() => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'letter');
                    const W = 215.9, H = 279.4, M = 15;
                    const CW = W - M*2;
                    let y = M;
                    const now = new Date();
                    const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

                    // Red header - taller for better readability
                    doc.setFillColor(211, 47, 47);
                    doc.rect(0, 0, W, 38, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(24);
                    doc.setFont('helvetica', 'bold');
                    doc.text('South Carolina Ice Storm', M, 16);
                    doc.setFontSize(13);
                    doc.setFont('helvetica', 'normal');
                    doc.text('DR 153-26 | Disaster Operations Briefing', M, 25);
                    doc.setFontSize(10);
                    doc.text('Prepared By: Gary Pelletier | ' + dateStr, M, 33);
                    y = 46;

                    // Stats bar
                    const articles = currentArticles || [];
                    const sources = {};
                    articles.forEach(a => sources[a.source] = (sources[a.source] || 0) + 1);
                    doc.setFillColor(245, 245, 245);
                    doc.rect(M, y, CW, 12, 'F');
                    doc.setTextColor(198, 40, 40);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(articles.length + ' News Articles', M + 5, y + 8);
                    doc.text(Object.keys(sources).length + ' Sources Monitored', M + 50, y + 8);
                    doc.text('Report Generated: ' + now.toLocaleTimeString(), M + 110, y + 8);
                    y += 20;

                    // Executive Summary
                    doc.setTextColor(198, 40, 40);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('EXECUTIVE SUMMARY', M, y);
                    y += 2;
                    doc.setDrawColor(255, 205, 210);
                    doc.setLineWidth(0.5);
                    doc.line(M, y, M + CW, y);
                    y += 6;

                    doc.setTextColor(51, 51, 51);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    const execSummary = aiSummary?.executive_summary || 'This report compiles ' + articles.length + ' news articles from South Carolina media sources covering the current ice storm. Review the news articles below for specific details on impacts, closures, and emergency response activities.';
                    const execLines = doc.splitTextToSize(execSummary, CW);
                    doc.text(execLines, M, y);
                    y += execLines.length * 4.5 + 8;

                    // Key Impacts Section
                    if (y > H - 60) { doc.addPage(); y = M; }
                    doc.setTextColor(198, 40, 40);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('KEY IMPACTS BY CATEGORY', M, y);
                    y += 2;
                    doc.line(M, y, M + CW, y);
                    y += 8;

                    const impacts = aiSummary?.key_impacts || {
                        power_outages: ['See news articles below for power outage details'],
                        road_conditions: ['See news articles below for road conditions'],
                        schools_closures: ['See news articles below for school closures'],
                        shelters_warming: ['See news articles below for shelter information'],
                        emergency_response: ['See news articles below for emergency response']
                    };

                    const categories = [
                        {title: 'POWER & UTILITIES', key: 'power_outages', icon: 'âš¡'},
                        {title: 'ROAD CONDITIONS', key: 'road_conditions', icon: 'ðŸš—'},
                        {title: 'SCHOOLS & CLOSURES', key: 'schools_closures', icon: 'ðŸ«'},
                        {title: 'SHELTERS & WARMING CENTERS', key: 'shelters_warming', icon: 'ðŸ '},
                        {title: 'EMERGENCY RESPONSE', key: 'emergency_response', icon: 'ðŸš¨'}
                    ];

                    categories.forEach(cat => {
                        if (y > H - 40) { doc.addPage(); y = M; }
                        doc.setFillColor(255, 235, 238);
                        doc.rect(M, y - 3, CW, 7, 'F');
                        doc.setTextColor(198, 40, 40);
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.text(cat.title, M + 2, y + 2);
                        y += 8;

                        doc.setTextColor(51, 51, 51);
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        const items = impacts[cat.key] || [];
                        items.slice(0, 4).forEach(item => {
                            if (y > H - 20) { doc.addPage(); y = M; }
                            const lines = doc.splitTextToSize('â€¢ ' + item, CW - 5);
                            doc.text(lines, M + 3, y);
                            y += lines.length * 3.5 + 1;
                        });
                        y += 4;
                    });

                    // Critical Numbers
                    if (y > H - 50) { doc.addPage(); y = M; }
                    y += 4;
                    doc.setTextColor(198, 40, 40);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('CRITICAL NUMBERS', M, y);
                    y += 2;
                    doc.line(M, y, M + CW, y);
                    y += 8;

                    const nums = aiSummary?.critical_numbers || {
                        estimated_outages: 'See coverage',
                        crashes_reported: 'See coverage',
                        shelters_open: 'See coverage',
                        schools_affected: 'See coverage'
                    };

                    doc.setFillColor(245, 245, 245);
                    doc.rect(M, y - 2, CW, 20, 'F');
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(51, 51, 51);
                    doc.text('Power Outages: ' + (nums.estimated_outages || 'N/A'), M + 5, y + 5);
                    doc.text('Crashes: ' + (nums.crashes_reported || 'N/A'), M + 5, y + 12);
                    doc.text('Shelters: ' + (nums.shelters_open || 'N/A'), M + 90, y + 5);
                    doc.text('Schools: ' + (nums.schools_affected || 'N/A'), M + 90, y + 12);
                    y += 28;

                    // Action Items
                    if (y > H - 50) { doc.addPage(); y = M; }
                    doc.setTextColor(198, 40, 40);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('RECOMMENDED ACTIONS', M, y);
                    y += 2;
                    doc.line(M, y, M + CW, y);
                    y += 8;

                    const actions = aiSummary?.action_items || [
                        'Review news articles below for current situation details',
                        'Check utility company websites for live outage maps',
                        'Monitor local news sources for road condition updates',
                        'Contact local emergency management for shelter locations'
                    ];

                    doc.setTextColor(51, 51, 51);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    actions.slice(0, 6).forEach((action, i) => {
                        if (y > H - 20) { doc.addPage(); y = M; }
                        doc.setFillColor(i % 2 === 0 ? 255 : 250, i % 2 === 0 ? 255 : 250, i % 2 === 0 ? 255 : 250);
                        const lines = doc.splitTextToSize((i+1) + '. ' + action, CW - 5);
                        doc.text(lines, M + 2, y);
                        y += lines.length * 3.5 + 3;
                    });
                    y += 6;

                    // Resources
                    if (y > H - 40) { doc.addPage(); y = M; }
                    doc.setTextColor(198, 40, 40);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('RESOURCES & CONTACTS', M, y);
                    y += 2;
                    doc.line(M, y, M + CW, y);
                    y += 8;

                    const resources = aiSummary?.resources_mentioned || [
                        'See news articles for specific contact information'
                    ];

                    doc.setTextColor(51, 51, 51);
                    doc.setFontSize(9);
                    resources.slice(0, 5).forEach(r => {
                        doc.text('â€¢ ' + r, M + 2, y);
                        y += 5;
                    });

                    // News Headlines (new page)
                    doc.addPage();
                    y = M;
                    doc.setFillColor(211, 47, 47);
                    doc.rect(0, 0, W, 18, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('NEWS ARTICLE DETAILS', M, 12);
                    y = 26;

                    articles.slice(0, 20).forEach((article, idx) => {
                        if (y > H - 30) { doc.addPage(); y = M; }
                        doc.setFontSize(8);
                        doc.setTextColor(198, 40, 40);
                        doc.setFont('helvetica', 'bold');
                        doc.text(article.source.toUpperCase(), M, y);
                        y += 4;
                        doc.setFontSize(10);
                        doc.setTextColor(51, 51, 51);
                        const titleLines = doc.splitTextToSize(article.title, CW);
                        doc.text(titleLines, M, y);
                        y += titleLines.length * 4 + 1;
                        if (article.summary) {
                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(102, 102, 102);
                            const sumLines = doc.splitTextToSize(article.summary.slice(0, 180), CW);
                            doc.text(sumLines, M, y);
                            y += sumLines.length * 3.5;
                        }
                        doc.setFontSize(8);
                        doc.setTextColor(153, 153, 153);
                        doc.text(article.published?.slice(0, 25) || '', M, y);
                        y += 8;
                    });

                    // Footer on every page
                    const totalPages = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.setTextColor(153, 153, 153);
                        doc.text('American Red Cross | DR 153-26 | Page ' + i + ' of ' + totalPages, M, H - 8);
                        doc.text('Generated: ' + now.toISOString().slice(0, 16).replace('T', ' '), W - M - 45, H - 8);
                    }

                    doc.save('SC-DR153-26-Briefing-' + now.toISOString().slice(0,10) + '.pdf');
                } catch (error) {
                    console.error('PDF Error:', error);
                    alert('Error generating PDF');
                } finally {
                    overlay.classList.remove('active');
                }
            }, 100);
        }

        refreshNews();
        setInterval(refreshNews, 30 * 60 * 1000);
    </script>
</body>
</html>
